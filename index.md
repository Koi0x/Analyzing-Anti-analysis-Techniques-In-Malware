## Analyzing Anti-anlysis Techniques In Malware - koi0x

In this write-up, I will be diving into the anti-analysis techniques used by malware in the wild. There are many different ways this is conducted. For example, processor checks, registry key checks, running process checks, and other checks such as virtual port checks and CPUID checks. I will try to keep this write-up short and to the point, as it's easy to over-explain. These techniques are not all universally the same when it comes to their implementation in malware nor are they always implemented in every malware sample that comes across the tape. However, these are the most commonly used techniques that you will find. Let's begin.    

### Checking the CPUID

For the first anti-analysis technique, we will be looking at the CPUID checks. CPUID is an assembly-level instruction that allows for a program to pull down information regarding the current processor.  This is important for malware authors because it can provide insight into the current processor manufacturer string. This is a very common technique used for multiple reasons. For example, there are no direct API calls needed to make it work and it also is easily overlooked by researchers who are not only trying to do dynamic analysis in a virtualized/sandboxed environment but also static analysis. Now that we have the basics out of the way, let's get a deeper understanding of how this works. 

From the cyberbit post [here](https://www.cyberbit.com/blog/endpoint-security/anti-vm-and-anti-sandbox-explained/), it exaplins the following:

```markdown
This instruction is executed with EAX=1 as input, the return value describes the processors features. 
The 31st bit of ECX on a physical machine will be equal to 0. On a guest VM it will equal to 1.
```
Let's take a look at this code sample below. It is just a basic C++ program that uses inline assembly to check the value of the 31st bit in the ECX register. Remember, in an un-altered virtualized environment, this value will be equal to 1. Below the inline assembly, I added a small amount of logic to show how it might be used in a sample, but obviously, they won't just exit the program, the steps to halt the execution of the sample will be more complex.

```C++
#include <iostream>

int main()
{
    bool VmCheck = false;
    __asm {
        xor eax, eax
        inc    eax
        cpuid
        bt     ecx, 0x1f  
        jc     TrueVM
        FalseVM :
        jmp     NopInstruct
        TrueVM :
        mov    VmCheck, 0x1
        NopInstruct :
        nop
    }
    if (VmCheck == 1)
    {
        exit(0);
    }
    else
    {
        std::cout << "Device is not virtualized" << std::endl;
    }
    return 0;
}
```
For more details see [Basic writing and formatting syntax](https://docs.github.com/en/github/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax).

### Jekyll Themes

Your Pages site will use the layout and styles from the Jekyll theme you have selected in your [repository settings](https://github.com/Koi0x/Analyzing-Anti-anlysis-Techniques-In-Malware/settings/pages). The name of this theme is saved in the Jekyll `_config.yml` configuration file.

### Support or Contact

Having trouble with Pages? Check out our [documentation](https://docs.github.com/categories/github-pages-basics/) or [contact support](https://support.github.com/contact) and weâ€™ll help you sort it out.
